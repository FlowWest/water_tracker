# Run auction-wide analysis
#
# This needs to be run only once as the predecessor to the split-level analyses
options(suppressPackageStartupMessages = TRUE)
options("rgdal_show_exportToProj4_warnings"="none")
options(warn = -1)

source("sqs-appender.R")
source("localenv.R")

q_url <- "https://sqs.us-west-2.amazonaws.com/975050180415/water-tracker-Q"
bid_name <- "test-test"

# logger::log_appender(appender_sqs(bid_name = bid_name, sqs_url = q_url))
logger::log_appender(logger::appender_console)

# Load definitions and code
def_file <- file.path(getwd(), "code/definitions.R")
code_files <- file.path(getwd(), "code/functions/", c("00_shared_functions.R", "03_water_x_landcover.R", "04_water_moving_window.R", "05_predict_birds.R"))
x <- sapply(c(def_file, code_files), FUN = function(x) source(x)) # assigned to x just to not have output

# Overlay water and landcover layers --------------------------
# This section is pretty fast, but it may make sense to split by landcovers here, and process each the rest of the
# way on a separate core

# Specify the (monthly) long term average water files to process; usually 3-4 per auction
water_files <- file.path(water_average_dir, c("p44r33_average_Aug_2010-2020.tif", "p44r33_average_Sep_2010-2020.tif"))
files_not_found <- file.exists(water_files)[!which(file.exists(water_files))]
if (length(files_not_found) != 0) {
  message_ts("landcover files missing {files_not_found}")
}



# Specify landcover files; lc_dir defined in definitions.R
landcovers <- c("Rice", "Corn", "Grain", "NonRiceCrops", "TreatedWetland", "Wetland_SemiSeas", "AltCrop")
landcover_files <- file.path(landcover_dir, paste0(landcovers, "_p44r33.tif"))
files_not_found <- file.exists(landcover_files)[!which(file.exists(landcover_files))]
if (length(files_not_found) > 0) {
  message_ts("landcover files missing {files_not_found}")
}

# Overlay water and landcover
# Function defined in functions/03_water_x_landcover.R
wxl_files <- overlay_water_landcover(water_files[1:2],
                                     landcover_files[1:2],
                                     output_dir = avg_wxl_dir)  #avg_wxl_dir defined in definitions.R


# Calculate moving windows -------------------------------------
# Use returned filenames from previous function as input; alternatively could define via table or directory search
# This is where it gets slow; may want to split this among multiple cores by dividing up wxl_files
#
# These files are required by the split-level bird predictions

# Create mean neighborhood water rasters
# Function defined in functions/04_water_moving_window.R
fcl_files <- mean_neighborhood_water(wxl_files,                #previously-created water x landcover files
                                    distances = c(250, 5000), #250m and 5km
                                    output_dir = avg_fcl_dir,
                                    trim_extent = FALSE)      #only set for TRUE with splits

stop("END OF MODEL ------------------------", call. = FALSE)

# Create bird predictions -------------------------------------
# This is messy because the models need a ton of files from different places.
# Everything is passed via the function call.

# Can pass all fcl_files if divided processing upstream or subset fcl_files here and call multiple instances.
# If splitting, ensure all files from one flooding area and month are included

# fcl_files for the auction-level analysis are the long term ones
fcl_files_longterm <- fcl_files

# Can subset files using the scenarios parameter, which is applied as a regex filter
scenarios_filter <- "water"

# values passed to model_files, model_names, covariate_files, covariate_names, and monthly_files
#    will change rarely and are specified in definitions.R

prd_files <- predict_bird_rasters(fcl_files,
                                  fcl_files_longterm,
                                  scenarios = scenarios_filter,
                                  water_months = c("Aug", "Sep"),
                                  model_files = shorebird_model_files_long,
                                  model_names = shorebird_model_names_long,
                                  static_cov_files = bird_model_cov_files,
                                  static_cov_names = bird_model_cov_names,
                                  monthly_cov_files = tmax_files,
                                  monthly_cov_months = tmax_months,
                                  monthly_cov_names = tmax_names,
                                  output_dir = avg_prd_dir)


